---
title: "Code Quality and Style"
date: "Last update: `r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "styles.css"] 
    seal: false
    #chakra: libs/remark-latest.min.js
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      titleSlideClass: [center, middle]
---

class: center, middle



```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)

library(ggplot2)
library(tidyverse)
library(readr)
library(gridExtra)
library(cowplot)

#library(jtools)


knitr::opts_chunk$set(fig.retina = 3, 
                      warning = FALSE, 
                      message = FALSE)



theme_set(theme_minimal(base_size = 20)) # sets a default ggplot theme

#has_bash <- Sys.which('bash') != '' && .Platform$OS.type != 'windows'

library(RefManageR)
bib <- ReadBib("PracticeR_FINAL.bib", check = FALSE)
ui <- "- "
```




```{r best-features, echo=FALSE}
#search
xaringanExtra::use_search(show_icon = TRUE, position = "top-right")

xaringanExtra::use_progress_bar(color = "#023047", location = "top")

xaringanExtra::style_search(match_background = "black",
                            input_background = "white",
                            input_border = "black",
                            match_current_background = "green")


xaringanExtra::use_panelset()

xaringanExtra::use_clipboard()

```


```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent(
  base_color = "black",
  header_font_google = google_font("Lato"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Code")
)
```

```{r meta, echo=FALSE}
library(metathis)
meta() %>%
  meta_general(
    description = "A overview how to put R code into production.",
    generator = "xaringan and remark.js"
  ) %>% 
  meta_name("github-repo" = "edgar-treischl/Workshop_GitHubIntro") %>% 
  meta_social(
    title = "Make it reproducibleR: Put R in Production",
    url = "https://edgar-treischl.github.io/Workshop_reproducibleR/",
    og_type = "website",
    og_author = "Edgar J. Treischl"
  )
```


  
# Friends don't let friends ...

## These slides are work in progress

.large[Dr. Edgar J. Treischl] <br>
<a href="http://www.edgar-treischl.de" target="_blank">www.edgar-treischl.de</a>
<br/>
<br/>
.large[Last update: `r Sys.Date()`]
<br/>
<br/>
This presentation is licensed under a CC-BY-NC 4.0 license.
You may copy, distribute, and use the slides in your own work, as long as you give attribution to the original author on each slide that you use. Commercial use of the contents of these slides is not allowed.

<div class="remark-footer">
  <!-- Left-aligned image -->
  <img src="images/by-nceu.png" alt="Image left" width="150px" class="footer-left"/>
  
  <!-- Right-aligned GitHub logo -->
  <a href="https://github.com/edgar-treischl/Workshop_reproducibleR" target="_blank">
    <img src="https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png" 
         alt="GitHub logo" class="footer-right"/>
  </a>
</div>




```{css, echo = F}
.reduced_opacity {
  opacity: 0.5;
}
```


---
## Agenda



### 01 Bad Habits `r emoji::emoji("evil")` 
### 02 Coding conventions `r emoji::emoji("construction")`
### 03 Develop with style and grace `r emoji::emoji("sunglasses")`





---

class: middle, center, inverse

## Let's face the truth, develop code but ...




---
background-image: url("images/beaker2.gif")
background-size: cover
class: bottom, center


# .white[Get rid of bad habits first <br> `r emoji::emoji("smile")`] 

<div class="remark-footer"><a href="https://giphy.com/gifs/moodman-batman-smack-smacked-Qumf2QovTD4QxHPjy5" target="_blank" style="color: white;">Images source: MOODMAN</a></div>




---
## Wipe the Slate Clean: Restart R Like a Pro

- Ever had code that worked perfectly on your machine — but mysteriously breaks when someone else tries to run it?

- Old objects in your global environment, packages from another project, or global options you tweaked and forgot about — they all linger like ghosts. 



```{r, eval=FALSE}
# Leftover objects
important_setting <- "production"

# Previously loaded function from packages
library(mypackage)

# Changed global options
options(stringsAsFactors = TRUE)  # Please don't do this in 2025
```

Your code may unknowingly rely on these leftovers. It runs perfectly on your machine — but fails for anyone else who doesn’t share your local setup. 




---
## Wipe the Slate Clean: Restart R Like a Pro

.pull-left[

- `r emoji::emoji("repeat")` Restart your R session, run your code from scratch (Ctrl + Shift + F10) and make it a habit

- Do not save the workspace and do not load the workspace from an `.Rdata` file (Based on Bryan et al. 2021). 

- It’s the only way to ensure your script actually works in a fresh, clean R session 

 
#### The rm approach `r emoji::emoji("shoot")`

- `rm(list = ls())` deletes user-created objects from the global workspace.

- **But**: The script may break due to hidden dependencies on things you ran in this R process before you executed: Attached packages are not detached, changed options are not restored, working directory is untouched!





]

.pull-right[
<figure>
    <img src="https://rstats.wtf/img/rstudio-workspace.png" style="width: 100%"/>
</figure>
]


---
background-image: url(https://github.com/rstudio/hex-stickers/blob/main/PNG/knitr.png?raw=true)
background-position: 90% 5%
background-size: 8%

## R vs. Rmd

### `r emoji::emoji("finger")` Code lives in R, Code and Text in Rmd files

If you need to create a document from a source code, run:

```{r, eval=FALSE}
#spin converts an R script to an Rmd file
knitr::spin("script.R")
```

- Roxygen comments will be treated as text (more about that later)
- Add yaml header to the script to control the output


If you need to extract the code from an Rmd file, run:


```{r, eval=FALSE}
#Extracts R code chunks from Rmd files
knitr::purl()
```

- Adjust the level of extraction with the `documentation` parameter (e.g., code only)
- Set `purl = FALSE` to avoid the extraction of code chunks (see Xie 2024)


---
background-image: url("images/beaker1.gif")
background-size: cover
class: bottom, center

## .orange[Get rid of messy code `r emoji::emoji("silly")`] 





---
## 01: Write Clean Code

### Clean code prioritizes:

- Readability
- Simplicity
- Clarity

### Messy code often reveals itself through several common signs: 

- Long, complicated functions that try to do too much
- Duplicated code scattered throughout scripts
- Inconsistent naming that leaves you guessing what’s going on
- Absolute paths
- Hardcoded values


---

## Don't Go Places Where You Don't Belong ...

<img src="images/drake.png" style="width: 65%"/>


---

## 01: Abandon absolute paths, they will break anyway


```{r, eval=TRUE, error=TRUE}
# Don't:
readr::read_csv("~/Documents/Berichte/orig/104_data.csv")
```

### `r emoji::emoji("lightning")` Ceate a project and use the `here` package:

```{r}
# Here returns the path to the project
here::here()
```


```{r, eval=TRUE}
# Create a path to the file
here::here("data", "descriptive_title.csv")
```












---

## Avoid Hardcoding Values or I’ll Burn Your Code

.pull-left[

<div class="info-box">
  <i>`r emoji::emoji("parrot")`</i> The pain begins if you forget to integrate those values as function parameters and later on your code becomes a mess to maintain.
</div>


```{r, eval=FALSE}
library(dplyr)
filtered_data <- mtcars |> filter(mpg > 25)
```

]

.pull-right[

<div class="info-box">
  <i>`r emoji::emoji("parrot")`</i> What if you want to filter by a different age? You’d have to search through your code to find every instance of 30 and change it — and probably forget values.
</div>





```{r, eval=FALSE}
# Hardcoded rounding is not bad, true?
mtcars |> mutate(mpg_rounded = round(mpg, 2))
```

]







---

## AHV or I’ll Burn Your Code II


### Set parameters at the top of your file while developing ...

```{r}
round_digits <- 2
mpg_threshold <- 25

mtcars |>
  filter(mpg > mpg_threshold) |>
  mutate(mpg_rounded = round(mpg, round_digits))
```


- Once you start wrapping code into functions, pass those values as arguments — even if you don’t plan to change them right now. You’re future-proofing your code.


---

## AHV or I’ll Burn Your Code III

### Move it into a function with a default:

```{r}
filter_and_round <- function(data, mpg_limit, digits = 2) {
  data |>
    dplyr::filter(mpg > mpg_limit) |>
    dplyr::mutate(mpg_rounded = round(mpg, digits))
}

# Use the default
filter_and_round(mtcars, mpg_limit = 25)
```

=> This approach makes your code flexible, readable, and much easier to maintain. 

---
background-image: url("images/cookimonster.gif")
background-size: cover
class: bottom, center

## .white[Break into nice bites `r emoji::emoji("silly")`] 

---
# Modular Code

### `r emoji::emoji("point_right")` Each function should do one thing — and do it well

- Modularity means breaking your code into smaller, self-contained pieces—typically functions — where each one handles a specific task
- Instead of writing one long script that tries to do everything, modular code splits the work into clear, manageable chunks


### `r emoji::emoji("point_right")` This makes your code easier to read, test, and develop

- Each piece can be understood and worked on independently
- Reusable functions save time and reduce duplication
- Testing is simpler because you can write small, focused tests instead of validating everything at once
- And when changes are needed, they’re easier to make since you only need to update one part of the codebase


---

# Don’t Dump Everything in One Function

.pull-left[

- It’s tempting to just get everything working in a single function or a long R script — a pipeline that loads the data, cleans it, analyzes it, and spits out a plot or, more generally, the result.

- As soon as you need to tweak something, explain it to someone else, or reuse part of it, things get messy. Suddenly, you’re stuck picking apart a script that’s hard to read, hard to change, and the code may break.

]

.pull-right[

```{r, eval=FALSE}
# Load data
df <- read.csv("data.csv")

# Data cleaning
df <- df |> 
  filter(!is.na(price)) |> 
  mutate(price_log = log(price)) |> 
  do_furher_fancy_things

# Analysis
model <- lm(price_log ~ bedrooms + sqft, data = df)

# Plotting
plot(df$sqft, df$price_log)
```


]

### Keep it simple, stupid! Don't violated the KISS `r emoji::emoji("lips")` principle


---

# Don’t Dump Everything in One Function


<div class="info-box">
  <i>`r emoji::emoji("parrot")`</i> At first glance, it might seem fine — but now imagine you want to reuse the cleaning logic in a different script. Or test how the model works on another dataset. Or change the plotting code without rerunning the model. You’re stuck. Everything depends on everything else.
</div>

> Your next step is code modularization which means breaking your logic into small, focused functions that each do one thing. That’s called separation of concerns, and it’s what keeps your code from turning into a tangled mess of confusion. Do yourself a huge favour: break your code into logical, reusable pieces.

- Separate at least logically, for example, put function that belong to data preparation, analysis, and reporting into different functions.
- If you want to organize your codebase, create separate R scripts (e.g., analyze.R, plot.R) that follow your internal logic — and define functions for each logical, reusable step.



---

# Don’t Dump Everything in One Function

Break it down into smaller functions:

```r
# source.R
load_data <- function(path) {
  read.csv(path)
}

clean_data <- function(df) {
  df |> filter(!is.na(price)) |> mutate(price_log = log(price))
  ...
}

#> And so on ...
```


#### `r emoji::emoji("lightning")` This approach still violates the single responsibility principle, but it’s a start!


---

# Don’t Dump Everything in One Function

=> If the last code is saved in a file called `source.R`, you can source it and call the functions as needed.

```{r, eval=FALSE}
# Source the functions
source("source.R")

# Main script
df <- load_data("data.csv")
df_clean <- clean_data(df)
model <- fit_model(df_clean)
plot_relationship(df_clean)
```


<div class="info-box">
  <i>`r emoji::emoji("parrot")`</i> This version is better because it's modular, readable, and flexible. Want to swap in a new dataset? Easy. Want to test the clean_data function? Just do it, you are on fire.
</div>




---

# Don’t Dump Everything in One Function


If the code need to run in sequence, wrap them in a function that makes the workflow explicit.

```{r, eval=FALSE}
# Wrap the workflow in a function
run_job <- function(data_path) {
  df <- load_data(data_path)
  df_clean <- clean_data(df)
  model <- fit_model(df_clean)
  send_mail(result = model)
  result <- plot_relationship(df_clean)
  
  return(result)
}
```

- It helps others understand how your code fits together

- Only after we break our code into logical, reusable pieces, we can really get to understand how to refactor it. Of course, it is extra work, but it’s part of the development process.


---
# Don’t Repeat Yourself (DRY)


### `r emoji::emoji("point_right")` Wrap It in a Function

.pull-left[

<div class="info-box">
  <i>`r emoji::emoji("parrot")`</i> Repeating the same code multiple times increases the risk of errors, bloats scripts, and makes maintenance harder. The DRY principle encourages you to write logic once and reuse it via functions. This makes your code cleaner, easier to test, and more maintainable.
</div>



]

.pull-right[

```{r}
library(gapminder)
library(dplyr)

# Filter for Germany in 2007
germany_2007 <- gapminder |>
  filter(country == "Germany", year == 2007) |>
  select(country, year, lifeExp, gdpPercap)

# Filter for Japan in 2007
japan_2007 <- gapminder |>
  filter(country == "Japan", year == 2007) |>
  select(country, year, lifeExp, gdpPercap)

# Filter for France in 2007
# And so on ...
```


]






---
# Don’t Repeat Yourself II

- Turn repeated code into parameterized functions to save time and avoid bugs.

```{r}
slice_gapminder <- function(data, country, year) {
  data |>
    dplyr::filter(country == !!country, year == !!year) |>
    dplyr::select(country, year, lifeExp, gdpPercap)
}
```

Now it's clean and reusable:

```{r}
japan_2007 <- slice_gapminder(gapminder, "Japan", 2007)
japan_2007
```

Creating a function does not imply that we are ready yet.

---
# Don’t Repeat Yourself III

There is another very common blind spot when we apply functions:

```{r, eval=FALSE}
# Coding is hard work
japan_2002 <- slice_gapminder(gapminder, "Japan", 2002)
germany_2002 <- slice_gapminder(gapminder, "Germany", 2002)
france_2002 <- slice_gapminder(gapminder, "France", 2002)
```

`r emoji::emoji("point_right")` Functions itself do not solve the problem of repetition if we call them repeatedly with only slight variations. 


---
# Base R against DRY

```{r}
# Define inputs
countries <- c("Japan", "Germany", "France")
years <- rep(2002, length(countries))

# Apply the function to both vectors using mapply()
results_list <- mapply(function(country, year) {
  slice_gapminder(gapminder, country, year)
}, countries, years, SIMPLIFY = FALSE)

# Combine the list of data frames into one
results <- do.call(rbind, results_list)
results
```




---
## Say Hello to *Purrr*

.pull-left[

<div class="info-box">
  <i>`r emoji::emoji("parrot")`</i> The purrr package helps you avoid such repetitive code (Wickham and Henry 2025). The package is part of the tidyverse and provides a consistent, readable way to perform iteration in R. Instead of writing loops or repeating function calls manually, purrr lets you apply functions over lists, vectors, or data frames using a family of tools like map(), map2(), and pmap.
</div>


]

.pull-right[
<figure>
    <a href="https://purrr.tidyverse.org" target="_blank"><img src="https://purrr.tidyverse.org/logo.png" alt="purrr.tidyverse.org" width="55%" align="center"/>
</figure>
]





---
background-image: url(https://purrr.tidyverse.org/logo.png)
background-position: 90% 5%
background-size: 8%

## Purrr against DRY


```{r}
# Use purrr to iterate over countries and years
library(purrr)

# Extract the data for multiple countries and a specific year
countries <- c("Japan", "Germany", "France")
years <- rep(2002, length(countries))

# Map2 to apply the function across both vectors
results <- map2(countries, years, ~ slice_gapminder(gapminder, .x, .y))

# Map2 returns a list, so we can bind the results
results |> dplyr::bind_rows()
```


---
background-image: url(https://purrr.tidyverse.org/logo.png)
background-position: 90% 5%
background-size: 8%

## Purrr against DRY

- As outlined, you don’t need purrr to avoid repetition – you can achieve similar results using base R functions like `sapply()` and other *apply* variants. 

- This can be useful if you want to reduce dependencies or keep your code lightweight.

- However, purrr offers a more consistent and readable syntax, especially when working within the tidyverse ecosystem. Its functions are designed to work seamlessly with tibbles and dplyr verbs, making it easier to integrate into data analysis workflows.

- Purrr has further goodies like:
  - Progress bars
  - Parallel computing
  
### `r emoji::emoji("point_right")` Purrr your way and DRY!


---
background-image: url("images/beaker3.gif")
background-size: cover
class: bottom, center

# .white[Robust Code don't bite ... `r emoji::emoji("silly")`] 


---
# Robust Code

- A robust function behaves consistently: given the same input, it always returns the same output. This reliability starts with clearly defined inputs and outputs. 

A function should receive all the data it needs through its arguments—and return its results explicitly. 

- It should not rely on global variables or hidden dependencies. 

-  when each function is a self-contained unit, it’s easier to reuse and combine across your analysis or pipeline. 

- how to write functions that handle errors gracefully

- avoid unintended side effects (like accidental data exports)

- manage credentials securely


---
background-image: url(https://rlang.r-lib.org/logo.png)
background-position: 90% 5%
background-size: 8%

# Handle Errors Gracefully

.pull-left[

Write code that anticipates problems and handles them in a way that doesn’t crash your script or leave the user guessing (defensive programming)

- **Validating inputs**: check that function arguments meet expected criteria (e.g., correct type, range, format) before proceeding.

- **Catching errors**: use tryCatch() to manage potential errors during execution.

- **Helpful feedback**: when something goes wrong, provide clear, actionable error messages that guide the user on how to fix the issue.


]

.pull-right[

#### Check required input: `rlang::check_required(name)`

```{r, error=TRUE}
# This function requires a name argument
say_hello <- function(name) {
  rlang::check_required(name)
  
  # Do a lot of steps before we greet
  # Let user wait ;)
  
  return(paste("Hello", name, "!"))
}

say_hello()
```

]


---
background-image: url(https://rlang.r-lib.org/logo.png)
background-position: 90% 5%
background-size: 8%

# Handle Errors Gracefully II


.pull-left[

The `cli` package provides functions to create consistent and informative messages, warnings, and errors in R.

- Inform the user:

```{r, error=TRUE, message=TRUE, warining = TRUE}
cli::cli_alert_info("Checking input type with rlang")
```

- Success message:

```{r, error=TRUE, message=TRUE, warining = TRUE}
cli::cli_alert_success("Input type checked!")
```



]

.pull-right[

#### Abort if input is not a character: `rlang::is_character(name)`


```{r, error=TRUE, message=TRUE, warining = TRUE}
# Validate input types with rlang
say_hello <- function(name) {
  abort_message <- "Say my name, say my name, `name` must be a character vector."
  
  if (!rlang::is_character(name)) {
  cli::cli_abort(abort_message)
    }
  
  return(paste("Hello", name, "!"))
}

say_hello(1)
```

]











---
background-image: url("images/gonzo.gif")
background-size: cover
class: bottom, center

# .white[Develop with style `r emoji::emoji("silly")`] 




---
background-image: url(https://styler.r-lib.org/reference/figures/logo.png)
background-position: 90% 5%
background-size: 8%

## 01: Develop With Style(r)


.pull-left[

<div class="info-box">
  <i>`r emoji::emoji("parrot")`️️</i> "styler formats your code according to the tidyverse style guide (https://style.tidyverse.org) (or your custom style guide) so you can direct your attention to the content of your code" (Müller and Walthert 2024).
</div>


]

.pull-right[

```{r}
styler::style_text(
  "myFunction<-function( x,y){
  if(sum( x , y )==10){
    print( 'Sum is correct!' )
  }
}"
)

```

]


There a goodies if you develop an R package:

```{r, eval=FALSE}
styler::style_pkg()
```







---
background-image: url(https://github.com/r-lib/lintr/blob/main/man/figures/logo.png?raw=true)
background-position: 90% 5%
background-size: 8%


## 01: Lintr



.pull-left[

<div class="info-box">
  <i>`r emoji::emoji("parrot")`️</i>"lintr provides static code analysis for R. It checks for adherence to a given style, identifying syntax errors and possible semantic issues, then reports them to you so you can take action" (Hester et al. 2024).
</div>


]

.pull-right[

```{r}
lintr::lint(text = 'myFunction <- function(x, y) {
  if (sum(x, y) == 10) {
    print("Sum is correct!")
  }
}')
```

]



There are even more goodies `r emoji::emoji("bad")` if you develop an R package:

```{r, eval=FALSE}
#lintr::lint_dir(path = "R")
lintr::lint_package()
```












---
class: center, middle

.left-column[

## Keep in touch

#### <a href="https://edgar-treischl.de" target="_blank"><img src="https://avatars.githubusercontent.com/u/77931249?s=400&u=eaf1d0871b643dd32cc0ff9f777edef28e6569a8&v=4" alt="www.edgar-treischl.de" width="25%"/><br/>www.edgar-treischl.de</a>
<br/>

#### <a href="https://github.com/edgar-treischl/Workshop_reproducibleR" target="_blank"><img src="https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png" alt="https://github.com/edgar-treischl" width="30%"/><br/>edgar-treischl</a>


]

.right-column[


## Thank you for your attention!
<br/>

<img src="https://i.gifer.com/D71m.gif" style="width: 40%"/>

]







---

## References (1/2)


```{r, print_refs, results='asis', echo=FALSE, warning=FALSE, message=FALSE}

print(bib[key = "covr"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

print(bib[key = "lintr"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

print(bib[key = "here"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

print(bib[key = "styler"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

print(bib[key = "renv"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))


print(bib[key = "wickham_r_2015"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

print(bib[key = "testthat"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

print(bib[key = "usethis"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

```




---

## References (2/2)


```{r, print_refs2, results='asis', echo=FALSE, warning=FALSE, message=FALSE}

print(bib[key = "sessioninfo"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

print(bib[key = "roxygen2"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

print(bib[key = "pkgdown"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

print(bib[key = "devtools"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

print(bib[key = "knitr"], 
  .opts = list(check.entries = FALSE, 
               style = "html", 
               bib.style = "authoryear"))

```














